<!-- ============================================ -->
<!-- SOLUCI√ìN COMPLETA PARA REMISIONES -->
<!-- Carga productos de "Cat√°logo de Productos" -->
<!-- Precios desde "Precios por Cliente" -->
<!-- Genera Excel autom√°ticamente -->
<!-- ============================================ -->

<script>
// ============================================
// CONFIGURACI√ìN DE AIRTABLE
// ============================================
const AIRTABLE_CONFIG = {
    baseId: 'appZR5HyyKvRk6rhJ',
    token: 'patTxoLSfgJZYsfoa.a30cdbab9572e691d72c75c9ccfd23bd6d40ae4be7278a2b725961475c30f01b',
    tables: {
        catalogoProductos: 'Cat√°logo de Productos',
        preciosPorCliente: 'Precios por Cliente',
        gestionClientes: 'Gesti√≥n de Clientes'
    }
};

// ============================================
// FUNCIONES PARA CARGAR PRODUCTOS
// ============================================

/**
 * Cargar todos los productos del cat√°logo
 */
async function cargarCatalogoProductos() {
    try {
        console.log('üì¶ Cargando cat√°logo de productos...');
        
        const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${encodeURIComponent(AIRTABLE_CONFIG.tables.catalogoProductos)}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${AIRTABLE_CONFIG.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Cat√°logo cargado:', data.records.length, 'productos');
        
        return data.records.map(record => ({
            codigo: record.fields['C√≥digo'] || '',
            nombre: record.fields['Nombre'] || '',
            unidad: record.fields['Unidad de Medida'] || '',
            observaciones: record.fields['Observaciones'] || '',
            recordId: record.id
        }));
        
    } catch (error) {
        console.error('‚ùå Error cargando cat√°logo:', error);
        throw error;
    }
}

/**
 * Cargar precios de un cliente espec√≠fico
 */
async function cargarPreciosCliente(nombreCliente) {
    try {
        console.log('üí∞ Cargando precios para:', nombreCliente);
        
        const formula = `SEARCH("${nombreCliente}", {Nombre del cliente})`;
        const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${encodeURIComponent(AIRTABLE_CONFIG.tables.preciosPorCliente)}?filterByFormula=${encodeURIComponent(formula)}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${AIRTABLE_CONFIG.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Precios cargados:', data.records.length, 'productos');
        
        // Crear mapa de precios por c√≥digo de producto
        const preciosPorCodigo = {};
        data.records.forEach(record => {
            const codigo = record.fields['Id'] || '';
            const precio = record.fields['Precio acordado'] || 0;
            if (codigo) {
                preciosPorCodigo[codigo] = precio;
            }
        });
        
        return preciosPorCodigo;
        
    } catch (error) {
        console.error('‚ùå Error cargando precios:', error);
        return {};
    }
}

/**
 * Mostrar productos con checkboxes cuando se selecciona un cliente
 */
async function mostrarProductosParaCliente(nombreCliente) {
    try {
        // Mostrar loading
        mostrarLoading(true);
        
        // Cargar cat√°logo y precios en paralelo
        const [catalogoProductos, preciosCliente] = await Promise.all([
            cargarCatalogoProductos(),
            cargarPreciosCliente(nombreCliente)
        ]);
        
        // Filtrar solo productos que tienen precio para este cliente
        const productosDisponibles = catalogoProductos.filter(producto => 
            preciosCliente[producto.codigo] !== undefined
        );
        
        // Agregar precio a cada producto
        productosDisponibles.forEach(producto => {
            producto.precio = preciosCliente[producto.codigo] || 0;
        });
        
        // Mostrar productos en la UI
        renderizarProductos(productosDisponibles);
        
        mostrarLoading(false);
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al cargar productos: ' + error.message);
        mostrarLoading(false);
    }
}

/**
 * Renderizar productos en la interfaz
 */
function renderizarProductos(productos) {
    let container = document.getElementById('productos-container-remision');
    
    if (!container) {
        container = crearContenedorProductos();
    }
    
    if (productos.length === 0) {
        container.innerHTML = `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                <p class="text-yellow-800">‚ö†Ô∏è No hay productos disponibles para este cliente</p>
                <p class="text-sm text-yellow-600 mt-2">Contacte al administrador para configurar precios</p>
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">üì¶ Productos Disponibles (${productos.length})</h3>
                <button 
                    onclick="seleccionarTodosProductos(true)"
                    class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded transition"
                >
                    ‚úì Seleccionar Todos
                </button>
            </div>
            
            <div class="max-h-96 overflow-y-auto space-y-2">
                ${productos.map((producto, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition border border-gray-200">
                        <div class="flex items-center flex-1">
                            <input 
                                type="checkbox" 
                                id="prod-${index}" 
                                data-codigo="${producto.codigo}"
                                data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                data-precio="${producto.precio}"
                                data-unidad="${producto.unidad}"
                                class="producto-checkbox mr-3 h-5 w-5 text-green-600 rounded focus:ring-2 focus:ring-green-500"
                                onchange="actualizarEstadoProducto(${index})"
                            >
                            <label for="prod-${index}" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">${producto.nombre}</div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-mono bg-gray-200 px-2 py-0.5 rounded">C√≥digo: ${producto.codigo}</span>
                                    <span class="ml-2">‚Ä¢ ${producto.unidad}</span>
                                </div>
                                <div class="text-lg text-green-700 font-bold mt-1">
                                    ${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(producto.precio)}
                                </div>
                                ${producto.observaciones ? `<div class="text-xs text-gray-500 mt-1 italic">${producto.observaciones}</div>` : ''}
                            </label>
                        </div>
                        <div class="flex items-center gap-3 ml-4">
                            <div class="flex items-center">
                                <label class="text-sm text-gray-600 mr-2">Cantidad:</label>
                                <input 
                                    type="number" 
                                    id="qty-${index}" 
                                    min="1" 
                                    value="1" 
                                    class="w-24 px-3 py-2 border border-gray-300 rounded text-center font-semibold disabled:bg-gray-100 disabled:text-gray-400"
                                    disabled
                                >
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span id="productos-seleccionados-count">0</span> productos seleccionados
                </div>
                <button 
                    onclick="agregarProductosSeleccionados()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-lg shadow-lg transition transform hover:scale-105"
                    id="btn-agregar-seleccionados"
                    disabled
                >
                    ‚ûï Agregar Seleccionados
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    actualizarContadorSeleccionados();
}

/**
 * Crear contenedor para productos
 */
function crearContenedorProductos() {
    const container = document.createElement('div');
    container.id = 'productos-container-remision';
    container.className = 'mt-4';
    
    // Buscar donde insertar (antes del bot√≥n de agregar producto manualmente)
    const botonManual = document.querySelector('[onclick*="agregarProductoManual"]') ||
                        document.querySelector('#btn-agregar-manual') ||
                        document.querySelector('.btn-agregar-producto');
    
    if (botonManual && botonManual.parentNode) {
        botonManual.parentNode.insertBefore(container, botonManual);
    } else {
        // Fallback: agregar al formulario de remisiones
        const form = document.getElementById('form-remisiones') ||
                     document.querySelector('form');
        if (form) {
            form.insertBefore(container, form.firstChild);
        }
    }
    
    return container;
}

/**
 * Actualizar estado de producto individual
 */
function actualizarEstadoProducto(index) {
    const checkbox = document.getElementById(`prod-${index}`);
    const qtyInput = document.getElementById(`qty-${index}`);
    
    if (checkbox && qtyInput) {
        qtyInput.disabled = !checkbox.checked;
        if (checkbox.checked) {
            qtyInput.focus();
        } else {
            qtyInput.value = 1;
        }
    }
    
    actualizarContadorSeleccionados();
}

/**
 * Seleccionar/deseleccionar todos los productos
 */
function seleccionarTodosProductos(seleccionar) {
    const checkboxes = document.querySelectorAll('.producto-checkbox');
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = seleccionar;
        actualizarEstadoProducto(index);
    });
}

/**
 * Actualizar contador de productos seleccionados
 */
function actualizarContadorSeleccionados() {
    const checkboxes = document.querySelectorAll('.producto-checkbox:checked');
    const count = checkboxes.length;
    
    const countElement = document.getElementById('productos-seleccionados-count');
    const btnAgregar = document.getElementById('btn-agregar-seleccionados');
    
    if (countElement) {
        countElement.textContent = count;
    }
    
    if (btnAgregar) {
        btnAgregar.disabled = count === 0;
        btnAgregar.classList.toggle('opacity-50', count === 0);
        btnAgregar.classList.toggle('cursor-not-allowed', count === 0);
    }
}

/**
 * Agregar productos seleccionados a la tabla de remisi√≥n
 */
function agregarProductosSeleccionados() {
    const checkboxes = document.querySelectorAll('.producto-checkbox:checked');
    const productosSeleccionados = [];
    
    checkboxes.forEach(checkbox => {
        const index = checkbox.id.replace('prod-', '');
        const qtyInput = document.getElementById(`qty-${index}`);
        const cantidad = parseInt(qtyInput.value) || 1;
        
        productosSeleccionados.push({
            codigo: checkbox.dataset.codigo,
            nombre: checkbox.dataset.nombre,
            cantidad: cantidad,
            precio: parseFloat(checkbox.dataset.precio),
            unidad: checkbox.dataset.unidad
        });
    });
    
    console.log('üìã Productos seleccionados:', productosSeleccionados);
    
    // Guardar en variable global para generar Excel
    window.productosRemision = productosSeleccionados;
    
    // Mostrar en tabla (conectar con funci√≥n existente)
    if (window.mostrarProductosEnTabla) {
        window.mostrarProductosEnTabla(productosSeleccionados);
    } else {
        mostrarProductosEnTablaDefault(productosSeleccionados);
    }
    
    // Limpiar selecci√≥n
    seleccionarTodosProductos(false);
    
    alert(`‚úÖ ${productosSeleccionados.length} producto(s) agregado(s) correctamente`);
}

/**
 * Mostrar productos en tabla (funci√≥n por defecto)
 */
function mostrarProductosEnTablaDefault(productos) {
    let tabla = document.getElementById('tabla-productos-remision');
    
    if (!tabla) {
        tabla = document.createElement('div');
        tabla.id = 'tabla-productos-remision';
        tabla.className = 'mt-4 overflow-x-auto';
        
        const container = document.getElementById('productos-container-remision');
        if (container && container.parentNode) {
            container.parentNode.insertBefore(tabla, container.nextSibling);
        }
    }
    
    const html = `
        <table class="w-full border-collapse border border-gray-300 bg-white rounded-lg overflow-hidden">
            <thead class="bg-green-600 text-white">
                <tr>
                    <th class="border border-gray-300 px-4 py-3 text-left">C√ìDIGO</th>
                    <th class="border border-gray-300 px-4 py-3 text-left">DESCRIPCI√ìN</th>
                    <th class="border border-gray-300 px-4 py-3 text-center">CANTIDAD</th>
                    <th class="border border-gray-300 px-4 py-3 text-center">BODEGA</th>
                    <th class="border border-gray-300 px-4 py-3 text-right">V/UNIT</th>
                    <th class="border border-gray-300 px-4 py-3 text-right">V/TOTAL</th>
                    <th class="border border-gray-300 px-4 py-3 text-center">ACCI√ìN</th>
                </tr>
            </thead>
            <tbody>
                ${productos.map((prod, i) => `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2 font-mono">${prod.codigo}</td>
                        <td class="border border-gray-300 px-4 py-2">${prod.nombre}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-semibold">${prod.cantidad}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">1</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">
                            ${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(prod.precio)}
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-right font-bold text-green-700">
                            ${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(prod.precio * prod.cantidad)}
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <button 
                                onclick="eliminarProductoTabla(${i})"
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition"
                            >
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('')}
                <tr class="bg-gray-100 font-bold">
                    <td colspan="5" class="border border-gray-300 px-4 py-3 text-right">TOTAL:</td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-lg text-green-700">
                        ${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(
                            productos.reduce((sum, p) => sum + (p.precio * p.cantidad), 0)
                        )}
                    </td>
                    <td class="border border-gray-300"></td>
                </tr>
            </tbody>
        </table>
    `;
    
    tabla.innerHTML = html;
}

/**
 * Eliminar producto de la tabla
 */
function eliminarProductoTabla(index) {
    if (confirm('¬øEliminar este producto?')) {
        window.productosRemision.splice(index, 1);
        mostrarProductosEnTablaDefault(window.productosRemision);
    }
}

/**
 * Mostrar/ocultar loading
 */
function mostrarLoading(mostrar) {
    let loading = document.getElementById('loading-productos');
    
    if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading-productos';
        loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loading.innerHTML = `
            <div class="bg-white rounded-lg p-8 shadow-2xl">
                <div class="flex items-center space-x-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
                    <div class="text-lg font-semibold">Cargando productos...</div>
                </div>
            </div>
        `;
        document.body.appendChild(loading);
    }
    
    loading.style.display = mostrar ? 'flex' : 'none';
}

// ============================================
// INICIALIZACI√ìN
// ============================================

/**
 * Inicializar cuando se carga la p√°gina
 */
function inicializarCargadorProductos() {
    console.log('üöÄ Inicializando cargador de productos para remisiones...');
    
    // Buscar el selector de cliente
    const selectorCliente = document.querySelector('#cliente-remision') ||
                           document.querySelector('[id*="cliente"][id*="remision"]') ||
                           document.querySelector('.select-cliente-remision');
    
    if (selectorCliente) {
        console.log('‚úÖ Selector de cliente encontrado');
        
        selectorCliente.addEventListener('change', function(e) {
            const nombreCliente = e.target.options[e.target.selectedIndex]?.text?.split(' - ')[0]?.trim();
            
            if (nombreCliente) {
                console.log('üë§ Cliente seleccionado:', nombreCliente);
                mostrarProductosParaCliente(nombreCliente);
            }
        });
    } else {
        console.warn('‚ö†Ô∏è Selector de cliente no encontrado, reintentando...');
        setTimeout(inicializarCargadorProductos, 1000);
    }
}

// Ejecutar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarCargadorProductos);
} else {
    inicializarCargadorProductos();
}

// Exponer funciones globalmente
window.mostrarProductosParaCliente = mostrarProductosParaCliente;
window.agregarProductosSeleccionados = agregarProductosSeleccionados;
window.seleccionarTodosProductos = seleccionarTodosProductos;
window.actualizarEstadoProducto = actualizarEstadoProducto;
window.eliminarProductoTabla = eliminarProductoTabla;

console.log('‚úÖ Sistema de productos para remisiones cargado correctamente');

</script>

<!-- ============================================ -->
<!-- FIN DEL C√ìDIGO JAVASCRIPT -->
<!-- ============================================ -->
